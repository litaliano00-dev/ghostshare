<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GhostShare</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-tertiary: #111111;
            --accent-primary: #00ff88;
            --accent-secondary: #0099ff;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --success: #00ff88;
            --warning: #ffaa00;
            --error: #ff4444;
            --mobile-height: 100dvh;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            height: var(--mobile-height);
            position: fixed;
            width: 100%;
            max-height: var(--mobile-height);
        }

        /* Enhanced Background with Animated Particles */
        #bg-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            pointer-events: none;
            background: 
                radial-gradient(circle at 20% 80%, rgba(0, 255, 136, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 153, 255, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 170, 0, 0.02) 0%, transparent 50%);
        }

        .particle {
            position: absolute;
            background: var(--accent-primary);
            border-radius: 50%;
            pointer-events: none;
            opacity: 0.3;
        }

        /* Glass Morphism Containers */
        .glass {
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
        }

        .glass-intense {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 20px;
        }

        /* Modal System */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .modal-content {
            width: 95%;
            max-width: 400px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 15px;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: var(--text-primary);
        }

        /* Login/Register System - COMPACT */
        #auth-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: var(--mobile-height);
            padding: 15px;
            animation: fadeInScale 0.8s ease-out;
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .logo-container {
            text-align: center;
            margin-bottom: 20px;
            animation: glowPulse 4s ease-in-out infinite;
        }

        @keyframes glowPulse {
            0%, 100% { 
                filter: drop-shadow(0 0 20px rgba(0, 255, 136, 0.3));
            }
            50% { 
                filter: drop-shadow(0 0 30px rgba(0, 255, 136, 0.6));
            }
        }

        .logo {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .tagline {
            font-size: 0.9rem;
            color: var(--text-secondary);
            max-width: 320px;
            line-height: 1.4;
        }

        .auth-card {
            width: 100%;
            max-width: 360px;
            padding: 25px 20px;
            margin-top: 15px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 3px;
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .auth-tab.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--bg-primary);
        }

        .form-group {
            margin-bottom: 15px;
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            color: var(--accent-primary);
            font-weight: 600;
            font-size: 0.85rem;
        }

        .form-input {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-tertiary);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1);
        }

        .btn {
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--bg-primary);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.9rem;
            width: 100%;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 255, 136, 0.3);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Main App Interface - COMPACT */
        #app-container {
            display: none;
            height: var(--mobile-height);
            flex-direction: row;
            max-height: var(--mobile-height);
        }

        /* Enhanced Sidebar - COMPACT */
        #sidebar {
            width: 60px;
            padding: 15px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            overflow: hidden;
            font-size: 0.9rem;
        }

        .user-avatar img, .user-avatar gif {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-avatar:hover {
            transform: scale(1.1);
            border-color: var(--accent-primary);
        }

        .nav-item {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 6px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            position: relative;
            font-size: 0.9rem;
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--bg-primary);
            transform: scale(1.1);
        }

        .nav-item:hover:not(.active) {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Main Content Area */
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: var(--mobile-height);
            max-height: var(--mobile-height);
        }

        /* Enhanced Top Bar - COMPACT */
        #top-bar {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 60px;
        }

        .search-container {
            flex: 1;
            position: relative;
            margin-right: 12px;
        }

        .search-input {
            width: 100%;
            padding: 10px 40px 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            color: var(--text-primary);
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .action-btn:hover {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            transform: scale(1.1);
        }

        /* Chat Area - OPTIMIZED FOR MOBILE */
        #chat-area {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            height: calc(var(--mobile-height) - 120px);
        }

        .chat-welcome {
            text-align: center;
            padding: 40px 15px;
            animation: fadeInUp 0.8s ease-out;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .welcome-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.7;
        }

        /* Enhanced Messages - COMPACT */
        .message {
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: 14px;
            max-width: 85%;
            animation: messageSlideIn 0.3s ease-out;
            position: relative;
        }

        @keyframes messageSlideIn {
            from { 
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .message.incoming {
            background: var(--bg-tertiary);
            border-bottom-left-radius: 4px;
            margin-right: auto;
        }

        .message.outgoing {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--bg-primary);
            border-bottom-right-radius: 4px;
            margin-left: auto;
        }

        .message-sender {
            font-weight: 600;
            font-size: 0.75rem;
            margin-bottom: 3px;
            opacity: 0.8;
        }

        .message-time {
            font-size: 0.65rem;
            opacity: 0.6;
            margin-top: 3px;
            text-align: right;
        }

        /* Message Input - OPTIMIZED FOR MOBILE */
        #message-input {
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: var(--bg-secondary);
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            min-height: 70px;
        }

        .message-input-field {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .message-input-field:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .send-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: var(--bg-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4);
        }

        /* Floating Action Button - OPTIMIZED */
        .fab {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: var(--bg-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 12px 30px rgba(0, 255, 136, 0.5);
        }

        /* Friends & Groups List - COMPACT */
        .friends-list, .groups-list {
            padding: 15px;
            max-height: calc(var(--mobile-height) - 180px);
            overflow-y: auto;
        }

        .friend-item, .group-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .friend-item:hover, .group-item:hover {
            background: var(--bg-tertiary);
        }

        .friend-avatar, .group-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            overflow: hidden;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .friend-avatar img, .group-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .friend-info, .group-info {
            flex: 1;
        }

        .friend-name, .group-name {
            font-weight: 600;
            margin-bottom: 3px;
            font-size: 0.9rem;
        }

        .friend-status, .group-members {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .status-online {
            color: var(--success);
        }

        .status-offline {
            color: var(--text-secondary);
        }

        /* Profile Picture Upload - COMPACT */
        .profile-picture-upload {
            text-align: center;
            margin-bottom: 15px;
        }

        .profile-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 12px;
            background: var(--bg-tertiary);
            overflow: hidden;
            border: 3px solid var(--accent-primary);
        }

        .profile-preview img, .profile-preview gif {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            display: inline-block;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .file-input-label:hover {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }

        /* Mobile responsiveness - ENHANCED */
        @media (max-width: 768px) {
            #sidebar {
                width: 50px;
                padding: 10px 0;
            }

            .logo {
                font-size: 2rem;
            }

            .tagline {
                font-size: 0.8rem;
                max-width: 280px;
            }

            .message {
                max-width: 90%;
                padding: 8px 12px;
            }

            .fab {
                left: 12px;
                bottom: 70px;
                width: 44px;
                height: 44px;
                font-size: 1rem;
            }

            #top-bar {
                padding: 10px 12px;
                min-height: 55px;
            }

            .action-btn {
                width: 32px;
                height: 32px;
                font-size: 0.75rem;
            }

            /* Chat area optimization */
            #chat-area {
                padding: 12px;
                height: calc(var(--mobile-height) - 125px);
            }

            #message-input {
                padding: 10px 12px;
                min-height: 65px;
            }

            .chat-button {
                padding: 10px;
            }

            /* Improved mobile layout */
            #app-container {
                height: var(--mobile-height);
                max-height: var(--mobile-height);
            }

            #main-content {
                height: var(--mobile-height);
                max-height: var(--mobile-height);
            }

            .friends-list, .groups-list {
                max-height: calc(var(--mobile-height) - 150px);
                padding: 12px;
            }

            .chats-list {
                max-height: calc(var(--mobile-height) - 150px);
            }

            .modal-content {
                width: 95%;
                margin: 5px;
                max-height: 80vh;
            }

            /* Active chat area adjustment */
            #active-chat {
                display: flex;
                flex-direction: column;
                height: 100%;
            }

            #chat-messages {
                flex: 1;
                padding: 12px;
                overflow-y: auto;
                max-height: none;
                padding-bottom: 70px;
            }

            .user-avatar {
                width: 35px;
                height: 35px;
                margin-bottom: 15px;
            }

            .nav-item {
                width: 35px;
                height: 35px;
                margin: 5px 0;
            }
        }

        /* Extra small phones - ENHANCED */
        @media (max-width: 480px) {
            #sidebar {
                width: 45px;
            }

            .nav-item {
                width: 32px;
                height: 32px;
                font-size: 0.8rem;
            }

            .user-avatar {
                width: 32px;
                height: 32px;
                font-size: 0.8rem;
            }

            #message-input {
                padding: 8px 10px;
                min-height: 60px;
            }

            .message-input-field {
                padding: 10px 14px;
                font-size: 0.85rem;
            }

            .send-btn {
                width: 40px;
                height: 40px;
                font-size: 0.8rem;
            }

            /* Further mobile optimizations */
            #top-bar {
                padding: 8px 10px;
                min-height: 50px;
            }

            .search-input {
                padding: 8px 30px 8px 10px;
                font-size: 0.8rem;
            }

            .action-btn {
                width: 30px;
                height: 30px;
                font-size: 0.7rem;
            }

            #chat-area {
                padding: 10px;
                height: calc(var(--mobile-height) - 110px);
            }

            .message {
                max-width: 95%;
                padding: 8px 10px;
            }

            .friend-item, .group-item {
                padding: 8px;
            }

            .friend-avatar, .group-avatar {
                width: 32px;
                height: 32px;
            }

            .fab {
                left: 10px;
                bottom: 65px;
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            /* Ensure chat bar is always visible and properly sized */
            #message-input {
                padding: 8px 10px;
                background: var(--bg-secondary);
                backdrop-filter: blur(20px);
            }

            #chat-messages {
                padding-bottom: 65px;
            }

            /* Auth container adjustments */
            #auth-container {
                padding: 10px;
            }

            .auth-card {
                padding: 20px 15px;
            }

            .logo {
                font-size: 1.8rem;
            }
        }

        /* Very small screens - OPTIMIZED */
        @media (max-width: 360px) {
            #sidebar {
                width: 40px;
            }

            .nav-item {
                width: 30px;
                height: 30px;
                margin: 4px 0;
                font-size: 0.75rem;
            }

            .user-avatar {
                width: 30px;
                height: 30px;
                margin-bottom: 12px;
                font-size: 0.75rem;
            }

            #message-input {
                padding: 6px 8px;
                min-height: 55px;
                gap: 8px;
            }

            .message-input-field {
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            .send-btn {
                width: 36px;
                height: 36px;
                font-size: 0.75rem;
            }

            .fab {
                width: 36px;
                height: 36px;
                font-size: 0.9rem;
                bottom: 60px;
                left: 8px;
            }

            #chat-messages {
                padding-bottom: 60px;
            }

            /* Compact modals */
            .modal-body {
                padding: 12px;
            }

            .modal-header {
                padding: 12px;
            }

            .form-input {
                padding: 10px 12px;
            }

            .btn {
                padding: 10px 14px;
            }
        }

        /* Ultra small screens */
        @media (max-width: 320px) {
            #sidebar {
                width: 38px;
            }

            .logo {
                font-size: 1.6rem;
            }

            .tagline {
                font-size: 0.75rem;
            }

            .auth-card {
                padding: 15px 12px;
            }

            #top-bar {
                padding: 6px 8px;
            }

            .search-input {
                padding: 6px 25px 6px 8px;
            }
        }

        /* Loading Animation */
        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }

        .loading-dots span {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: var(--accent-primary);
            animation: loadingBounce 1.4s ease-in-out infinite both;
        }

        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes loadingBounce {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Notification System */
        .notification {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 12px 16px;
            border-radius: 8px;
            background: var(--bg-tertiary);
            border-left: 4px solid var(--accent-primary);
            z-index: 1001;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            max-width: 300px;
            font-size: 0.85rem;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left-color: var(--success);
        }

        .notification.error {
            border-left-color: var(--error);
        }

        /* Request buttons */
        .request-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .accept-btn, .decline-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }

        .accept-btn {
            background: var(--success);
            color: var(--bg-primary);
        }

        .decline-btn {
            background: var(--error);
            color: var(--text-primary);
        }

        .accept-btn:hover, .decline-btn:hover {
            transform: scale(1.05);
        }

        /* Chat list with scroll */
        .chats-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: calc(var(--mobile-height) - 180px);
            overflow-y: auto;
            padding: 8px;
        }

        .chat-button {
            display: flex;
            align-items: center;
            padding: 10px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 10px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            width: 100%;
        }

        .chat-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .chat-button.pinned {
            border-left: 4px solid var(--accent-primary);
        }

        .chat-button.blocked {
            opacity: 0.5;
        }

        .chat-options {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            display: none;
        }

        .chat-button:hover .chat-options {
            display: flex;
            gap: 4px;
        }

        .option-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.3s ease;
            font-size: 0.7rem;
        }

        .option-btn:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        /* Context menu for long press */
        .context-menu {
            position: fixed;
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 8px;
            z-index: 1002;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            display: none;
        }

        .context-menu button {
            display: block;
            width: 100%;
            padding: 6px 10px;
            background: none;
            border: none;
            color: var(--text-primary);
            text-align: left;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 4px;
            font-size: 0.8rem;
        }

        .context-menu button:hover {
            background: var(--bg-primary);
        }

        /* Security indicators */
        .security-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .security-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
        }

        .security-indicator.medium {
            background: var(--warning);
        }

        .security-indicator.low {
            background: var(--error);
        }

        /* Clip button and file upload */
        .clip-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .clip-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .file-options {
            position: absolute;
            bottom: 60px;
            left: 15px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 8px;
            display: none;
            flex-direction: column;
            gap: 4px;
            z-index: 1001;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .file-option {
            padding: 8px 12px;
            background: none;
            border: none;
            color: var(--text-primary);
            text-align: left;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .file-option:hover {
            background: var(--bg-primary);
        }

        .hidden-file-input {
            display: none;
        }

        /* File message styling */
        .file-message {
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-icon {
            font-size: 1.2rem;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            margin-bottom: 3px;
            font-size: 0.85rem;
        }

        .file-size {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .download-btn {
            background: var(--accent-primary);
            color: var(--bg-primary);
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.75rem;
        }

        /* Encryption status */
        .encryption-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--success);
            margin-top: 4px;
        }

        .encryption-badge {
            background: var(--success);
            color: var(--bg-primary);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: 600;
        }

        /* Group member list */
        .group-members-list {
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .group-member-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 6px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
        }

        .group-member-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 0.7rem;
        }

        .group-member-name {
            flex: 1;
            font-size: 0.85rem;
        }

        .group-member-role {
            font-size: 0.7rem;
            color: var(--accent-primary);
            background: rgba(0, 255, 136, 0.1);
            padding: 2px 6px;
            border-radius: 10px;
        }

        /* Friend request status */
        .friend-status-pending {
            color: var(--warning);
        }

        .friend-status-accepted {
            color: var(--success);
        }

        /* Prevent zoom on input focus for mobile */
        @media (max-width: 768px) {
            input, textarea, select {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div id="bg-particles"></div>

    <!-- Authentication System -->
    <div id="auth-container">
        <div class="logo-container">
            <div class="logo">GhostShare</div>
            <div class="tagline">Secure messaging with military-grade encryption and complete anonymity</div>
            <div class="security-status">
                <div class="security-indicator"></div>
                <span>End-to-End Encrypted</span>
            </div>
        </div>

        <div class="auth-card glass-intense">
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuthTab('login')">Login</div>
                <div class="auth-tab" onclick="switchAuthTab('register')">Register</div>
            </div>

            <div id="login-form">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="login-username" placeholder="Enter your username" maxlength="20">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="login-password" placeholder="Enter your password" minlength="8">
                </div>
                <button class="btn" onclick="login()">
                    <span>Access Secure Network</span>
                </button>
            </div>

            <div id="register-form" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Choose Username</label>
                    <input type="text" class="form-input" id="reg-username" placeholder="Create unique username" maxlength="20">
                </div>
                <div class="form-group">
                    <label class="form-label">Secure Password</label>
                    <input type="password" class="form-input" id="reg-password" placeholder="Minimum 8 characters" minlength="8">
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" class="form-input" id="reg-confirm-password" placeholder="Re-enter password" minlength="8">
                </div>
                <button class="btn" onclick="register()">
                    <span>Create Secure Account</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app-container">
        <!-- Sidebar Navigation -->
        <div id="sidebar" class="glass">
            <div class="user-avatar" onclick="showUserProfile()" id="user-avatar">
                <i class="fas fa-user-shield"></i>
            </div>

            <div class="nav-item active" onclick="switchView('chats')" title="Chats">
                <i class="fas fa-comments"></i>
            </div>

            <div class="nav-item" onclick="switchView('friends')" title="Friends">
                <i class="fas fa-users"></i>
            </div>

            <div class="nav-item" onclick="switchView('groups')" title="Groups">
                <i class="fas fa-layer-group"></i>
            </div>

            <div class="nav-item" onclick="showSettings()" title="Settings">
                <i class="fas fa-cog"></i>
            </div>

            <!-- Notifications Button -->
            <div class="nav-item" onclick="showNotifications()" title="Notifications" id="notifications-btn">
                <i class="fas fa-bell"></i>
                <span id="notification-badge" style="display: none; position: absolute; top: -5px; right: -5px; background: var(--error); color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 0.6rem; display: flex; align-items: center; justify-content: center;">0</span>
            </div>
        </div>

        <!-- Main Content -->
        <div id="main-content">
            <!-- Top Bar -->
            <div id="top-bar" class="glass">
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Search encrypted messages...">
                </div>
                <div class="action-buttons">
                    <button class="action-btn" onclick="showAddFriendModal()" title="Add Friend">
                        <i class="fas fa-user-plus"></i>
                    </button>
                    <button class="action-btn" onclick="showCreateGroupModal()" title="Create Group">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="action-btn" title="Security Status" onclick="showSecurityInfo()">
                        <i class="fas fa-shield-alt"></i>
                    </button>
                </div>
            </div>

            <!-- Chat Area -->
            <div id="chat-area">
                <div class="chat-welcome" id="chat-welcome">
                    <div class="welcome-icon">
                        <i class="fas fa-user-secret"></i>
                    </div>
                    <h2>Welcome to GhostShare</h2>
                    <p>Your conversations are encrypted end-to-end. Not even we can read them.</p>
                    <div class="security-status">
                        <div class="security-indicator"></div>
                        <span>All messages are encrypted</span>
                    </div>
                    <div class="encryption-status">
                        <i class="fas fa-lock"></i>
                        <span>End-to-End Encryption: Active</span>
                    </div>
                    <div class="loading-dots" style="margin-top: 15px;">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>

                <!-- Chats View -->
                <div id="chats-view" style="display: none;">
                    <h3 style="margin-bottom: 15px; padding: 0 15px; font-size: 1.1rem;">Your Chats</h3>
                    <div class="chats-list" id="chats-list">
                        <!-- Chat buttons will be dynamically added here -->
                    </div>
                </div>

                <!-- Friends View -->
                <div id="friends-view" style="display: none;" class="friends-list">
                    <h3 style="margin-bottom: 15px; font-size: 1.1rem;">Your Friends</h3>
                    <div id="friends-list"></div>
                </div>

                <!-- Groups View -->
                <div id="groups-view" style="display: none;" class="groups-list">
                    <h3 style="margin-bottom: 15px; font-size: 1.1rem;">Your Groups</h3>
                    <div id="groups-list"></div>
                </div>

                <!-- Active Chat View -->
                <div id="active-chat" style="display: none;">
                    <div id="chat-header" style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 8px; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div id="active-chat-avatar" style="width: 36px; height: 36px; border-radius: 50%; background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center; font-size: 0.8rem;"></div>
                            <div>
                                <div id="active-chat-name" style="font-weight: bold; font-size: 0.95rem;"></div>
                                <div id="active-chat-status" style="font-size: 0.75rem; color: var(--text-secondary);"></div>
                            </div>
                        </div>
                        <div class="encryption-badge">
                            <i class="fas fa-lock"></i> E2E Encrypted
                        </div>
                    </div>
                    <div id="chat-messages" style="flex: 1; padding: 15px; overflow-y: auto;">
                        <!-- Messages will appear here -->
                    </div>
                </div>
            </div>

            <!-- Message Input - OPTIMIZED FOR MOBILE -->
            <div id="message-input" class="glass" style="display: none;">
                <div style="position: relative;">
                    <button class="clip-btn" onclick="toggleFileOptions()">
                        ðŸ“Ž
                    </button>
                    <div class="file-options" id="file-options">
                        <button class="file-option" onclick="selectFile('image')">
                            <i class="fas fa-image"></i> Photo
                        </button>
                        <button class="file-option" onclick="selectFile('video')">
                            <i class="fas fa-video"></i> Video
                        </button>
                        <button class="file-option" onclick="selectFile('file')">
                            <i class="fas fa-file"></i> File
                        </button>
                    </div>
                </div>

                <input type="text" class="message-input-field" id="message-text" placeholder="Type encrypted message..." maxlength="1000">

                <input type="file" id="file-input" class="hidden-file-input" accept="*/*">
                <input type="file" id="image-input" class="hidden-file-input" accept="image/*">
                <input type="file" id="video-input" class="hidden-file-input" accept="video/*">

                <button class="send-btn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Modals - COMPACT VERSIONS -->
    <!-- Add Friend Modal -->
    <div id="add-friend-modal" class="modal">
        <div class="modal-content glass-intense">
            <div class="modal-header">
                <h3 style="font-size: 1.1rem;">Add Friend</h3>
                <button class="close-modal" onclick="closeModal('add-friend-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Friend's Username</label>
                    <input type="text" class="form-input" id="friend-username" placeholder="Enter username" maxlength="20">
                </div>
                <div class="form-group">
                    <label class="form-label">Optional Message</label>
                    <textarea class="form-input" id="friend-message" placeholder="Add a personal message (optional)" maxlength="200" style="min-height: 80px; resize: vertical;"></textarea>
                </div>
                <button class="btn" onclick="sendFriendRequest()">Send Friend Request</button>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div id="create-group-modal" class="modal">
        <div class="modal-content glass-intense">
            <div class="modal-header">
                <h3 style="font-size: 1.1rem;">Create Group</h3>
                <button class="close-modal" onclick="closeModal('create-group-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Group Name</label>
                    <input type="text" class="form-input" id="group-name" placeholder="Enter group name" maxlength="30">
                </div>
                <div class="form-group">
                    <label class="form-label">Group Description</label>
                    <textarea class="form-input" id="group-description" placeholder="Describe your group (optional)" maxlength="200" style="min-height: 80px; resize: vertical;"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Add Friends to Group</label>
                    <div id="friends-checkboxes" class="group-members-list"></div>
                </div>
                <button class="btn" onclick="createGroup()">Create Group</button>
            </div>
        </div>
    </div>

    <!-- Group Info Modal -->
    <div id="group-info-modal" class="modal">
        <div class="modal-content glass-intense">
            <div class="modal-header">
                <h3 style="font-size: 1.1rem;" id="group-info-title">Group Info</h3>
                <button class="close-modal" onclick="closeModal('group-info-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="group-info-content">
                    <!-- Group info will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div id="profile-modal" class="modal">
        <div class="modal-content glass-intense">
            <div class="modal-header">
                <h3 style="font-size: 1.1rem;">Profile Settings</h3>
                <button class="close-modal" onclick="closeModal('profile-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="profile-picture-upload">
                    <div class="profile-preview" id="profile-preview">
                        <i class="fas fa-user-shield" style="font-size: 2.5rem; color: var(--text-secondary);"></i>
                    </div>
                    <input type="file" id="profile-picture" class="file-input" accept="image/*, .gif">
                    <label for="profile-picture" class="file-input-label">Change Profile Picture</label>
                </div>

                <div class="form-group">
                    <label class="form-label">Username</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" class="form-input" id="profile-username" value="" readonly style="flex: 1;">
                        <button class="btn-secondary" onclick="enableUsernameEdit()" style="width: auto; padding: 8px 12px; font-size: 0.8rem;">Edit</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Current Password</label>
                    <input type="password" class="form-input" id="current-password" placeholder="Enter current password">
                </div>

                <div class="form-group">
                    <label class="form-label">New Password</label>
                    <input type="password" class="form-input" id="new-password" placeholder="Enter new password" minlength="8">
                </div>

                <div class="form-group">
                    <label class="form-label">Confirm New Password</label>
                    <input type="password" class="form-input" id="confirm-new-password" placeholder="Confirm new password" minlength="8">
                </div>

                <button class="btn" onclick="updateProfile()">Update Profile</button>
            </div>
        </div>
    </div>

    <!-- New Chat Modal -->
    <div id="new-chat-modal" class="modal">
        <div class="modal-content glass-intense">
            <div class="modal-header">
                <h3 style="font-size: 1.1rem;">New Chat</h3>
                <button class="close-modal" onclick="closeModal('new-chat-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Who would you like to chat with?</label>
                    <input type="text" class="form-input" id="chat-username" placeholder="Enter username" maxlength="20">
                </div>
                <button class="btn" onclick="startNewChat()">Start Chat</button>
            </div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notifications-modal" class="modal">
        <div class="modal-content glass-intense">
            <div class="modal-header">
                <h3 style="font-size: 1.1rem;">Notifications</h3>
                <button class="close-modal" onclick="closeModal('notifications-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="notifications-list">
                    <!-- Notifications will be added here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Security Info Modal -->
    <div id="security-modal" class="modal">
        <div class="modal-content glass-intense">
            <div class="modal-header">
                <h3 style="font-size: 1.1rem;">Security Information</h3>
                <button class="close-modal" onclick="closeModal('security-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="security-status" style="margin-bottom: 15px;">
                    <div class="security-indicator"></div>
                    <span style="font-weight: bold;">All Systems Secure</span>
                </div>

                <div style="margin-bottom: 12px;">
                    <h4 style="color: var(--accent-primary); margin-bottom: 8px; font-size: 0.95rem;">Encryption Status</h4>
                    <p style="font-size: 0.85rem;">âœ“ End-to-End Encryption: Active</p>
                    <p style="font-size: 0.85rem;">âœ“ Message Encryption: AES-256-GCM</p>
                    <p style="font-size: 0.85rem;">âœ“ Key Exchange: Secure Handshake</p>
                    <p style="font-size: 0.85rem;">âœ“ Forward Secrecy: Enabled</p>
                </div>

                <div style="margin-bottom: 12px;">
                    <h4 style="color: var(--accent-primary); margin-bottom: 8px; font-size: 0.95rem;">Security Features</h4>
                    <p style="font-size: 0.85rem;">âœ“ No message storage on servers</p>
                    <p style="font-size: 0.85rem;">âœ“ Automatic session expiration</p>
                    <p style="font-size: 0.85rem;">âœ“ Brute force protection</p>
                    <p style="font-size: 0.85rem;">âœ“ Input sanitization</p>
                    <p style="font-size: 0.85rem;">âœ“ Rate limiting</p>
                    <p style="font-size: 0.85rem;">âœ“ DDOS protection</p>
                </div>

                <div>
                    <h4 style="color: var(--accent-primary); margin-bottom: 8px; font-size: 0.95rem;">Privacy</h4>
                    <p style="font-size: 0.85rem;">âœ“ No data sharing with third parties</p>
                    <p style="font-size: 0.85rem;">âœ“ Anonymous usage</p>
                    <p style="font-size: 0.85rem;">âœ“ No message logging</p>
                    <p style="font-size: 0.85rem;">âœ“ Server cannot read messages</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="context-menu" class="context-menu">
        <button onclick="pinChat()">Pin Chat</button>
        <button onclick="unpinChat()">Unpin Chat</button>
        <button onclick="blockUser()">Block User</button>
        <button onclick="unblockUser()">Unblock User</button>
    </div>

    <!-- Notification System -->
    <div id="notification" class="notification">
        <div id="notification-message"></div>
    </div>

    <!-- Floating Action Button - OPTIMIZED -->
    <button class="fab" onclick="createNewChat()" title="New Chat">
        <i class="fas fa-edit"></i>
    </button>

    <script>
        // Application State
        let currentUser = null;
        let friends = [];
        let groups = [];
        let chats = [];
        let activeChat = null;
        let socket = null;
        let pendingRequests = [];
        let longPressTimer = null;
        let selectedChat = null;
        let encryptionKeys = new Map();

        // Enhanced Particle System
        function createParticles() {
            const container = document.getElementById('bg-particles');
            const particleCount = 30; // Reduced for mobile performance

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';

                const size = Math.random() * 3 + 1;
                const posX = Math.random() * 100;
                const posY = Math.random() * 100;
                const duration = Math.random() * 20 + 10;
                const delay = Math.random() * 5;

                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${posX}%`;
                particle.style.top = `${posY}%`;
                particle.style.animation = `float ${duration}s ease-in-out ${delay}s infinite`;

                container.appendChild(particle);
            }

            // Add floating animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes float {
                    0%, 100% { transform: translate(0, 0) rotate(0deg); }
                    25% { transform: translate(20px, -20px) rotate(90deg); }
                    50% { transform: translate(0, -40px) rotate(180deg); }
                    75% { transform: translate(-20px, -20px) rotate(270deg); }
                }
            `;
            document.head.appendChild(style);
        }

        // FIXED E2E Encryption Functions - Consistent Key Derivation
        async function generateEncryptionKey() {
            const key = await window.crypto.subtle.generateKey(
                { name: 'AES-GCM', length: 256 },
                true,
                ['encrypt', 'decrypt']
            );
            return key;
        }

        async function deriveChatKey(userId1, userId2) {
            // FIXED: Sort user IDs for consistent key derivation
            const sortedUserIds = [userId1, userId2].sort();
            const encoder = new TextEncoder();
            const data = encoder.encode(sortedUserIds[0] + sortedUserIds[1] + 'ghostshare-secret-salt-v2');
            const hash = await window.crypto.subtle.digest('SHA-256', data);
            return await window.crypto.subtle.importKey(
                'raw',
                hash,
                { name: 'AES-GCM' },
                false,
                ['encrypt', 'decrypt']
            );
        }

        async function encryptMessage(text, key) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const iv = window.crypto.getRandomValues(new Uint8Array(12));

            const encrypted = await window.crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                data
            );

            return {
                iv: Array.from(iv),
                data: Array.from(new Uint8Array(encrypted))
            };
        }

        async function decryptMessage(encryptedData, key) {
            try {
                const iv = new Uint8Array(encryptedData.iv);
                const data = new Uint8Array(encryptedData.data);

                const decrypted = await window.crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    data
                );

                const decoder = new TextDecoder();
                return decoder.decode(decrypted);
            } catch (error) {
                console.error('Decryption failed:', error);
                return 'ðŸ”’ Unable to decrypt message';
            }
        }

        function getChatKey(chatId, user1, user2) {
            // FIXED: Use sorted user IDs for consistent key lookup
            const keyId = [user1, user2].sort().join('-');
            if (!encryptionKeys.has(keyId)) {
                const keyPromise = deriveChatKey(user1, user2);
                encryptionKeys.set(keyId, keyPromise);
            }
            return encryptionKeys.get(keyId);
        }

        // Modal System
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            gsap.from(`#${modalId} .modal-content`, { duration: 0.5, scale: 0.8, opacity: 0 });
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Notification System
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const messageEl = document.getElementById('notification-message');

            messageEl.textContent = message;
            notification.className = `notification ${type} show`;

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Enhanced Authentication System
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.auth-tab:${tab === 'login' ? 'first-child' : 'last-child'}`).classList.add('active');

            document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('register-form').style.display = tab === 'register' ? 'block' : 'none';

            // Animation
            gsap.from(`#${tab}-form`, { duration: 0.5, y: 20, opacity: 0 });
        }

        async function login() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;

            if (!username || !password) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            // Show loading state
            const btn = document.querySelector('#login-form .btn span');
            btn.innerHTML = 'Verifying Identity <span class="loading-dots"><span></span><span></span><span></span></span>';

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (data.success) {
                    currentUser = data.user;
                    initializeApp();
                } else {
                    showNotification(data.message, 'error');
                    btn.innerHTML = 'Access Secure Network';
                }
            } catch (error) {
                showNotification('Login failed. Please try again.', 'error');
                btn.innerHTML = 'Access Secure Network';
            }
        }

        async function register() {
            const username = document.getElementById('reg-username').value.trim();
            const password = document.getElementById('reg-password').value;
            const confirmPassword = document.getElementById('reg-confirm-password').value;

            if (!username || !password) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showNotification('Passwords do not match!', 'error');
                return;
            }

            if (password.length < 8) {
                showNotification('Password must be at least 8 characters long!', 'error');
                return;
            }

            // Show loading state
            const btn = document.querySelector('#register-form .btn span');
            btn.innerHTML = 'Creating Secure Account <span class="loading-dots"><span></span><span></span><span></span></span>';

            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Account created successfully! Please login.');
                    switchAuthTab('login');
                } else {
                    if (data.message.includes('already exists')) {
                        showNotification('Username not available, try another one', 'error');
                    } else {
                        showNotification(data.message, 'error');
                    }
                }
            } catch (error) {
                showNotification('Registration failed. Please try again.', 'error');
            } finally {
                btn.innerHTML = 'Create Secure Account';
            }
        }

        function initializeApp() {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';

            // Initialize user data
            updateUserAvatar();
            loadFriends();
            loadGroups();
            loadChats();
            loadPendingRequests();

            // Connect to WebSocket
            socket = io();
            setupSocketListeners();

            // Notify server that user is online
            socket.emit('user_online', currentUser.username);

            // Animate app entrance
            gsap.from('#app-container', { duration: 1, y: 50, opacity: 0, ease: 'back.out(1.7)' });

            // Initialize encryption for existing chats
            initializeEncryption();
        }

        async function initializeEncryption() {
            // Pre-generate encryption keys for all existing chats
            for (const chat of chats) {
                await getChatKey(chat.id, currentUser.username, chat.withUser);
            }
        }

        function updateUserAvatar() {
            const avatar = document.getElementById('user-avatar');
            if (currentUser && currentUser.avatar) {
                avatar.innerHTML = `<img src="${currentUser.avatar}" alt="Profile">`;
            } else {
                avatar.innerHTML = '<i class="fas fa-user-shield"></i>';
            }
        }

        // View Management
        function switchView(view) {
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');

            // Hide all views
            document.getElementById('chat-welcome').style.display = 'none';
            document.getElementById('chats-view').style.display = 'none';
            document.getElementById('friends-view').style.display = 'none';
            document.getElementById('groups-view').style.display = 'none';
            document.getElementById('active-chat').style.display = 'none';
            document.getElementById('message-input').style.display = 'none';

            // Show selected view
            switch(view) {
                case 'chats':
                    document.getElementById('chats-view').style.display = 'block';
                    if (activeChat) {
                        document.getElementById('active-chat').style.display = 'block';
                        document.getElementById('message-input').style.display = 'flex';
                    } else {
                        document.getElementById('chat-welcome').style.display = 'block';
                    }
                    break;
                case 'friends':
                    document.getElementById('friends-view').style.display = 'block';
                    break;
                case 'groups':
                    document.getElementById('groups-view').style.display = 'block';
                    break;
            }
        }

        // Enhanced Friend System
        function showAddFriendModal() {
            showModal('add-friend-modal');
        }

        async function sendFriendRequest() {
            const friendUsername = document.getElementById('friend-username').value.trim();
            const message = document.getElementById('friend-message').value.trim();

            if (!friendUsername) {
                showNotification('Please enter a username', 'error');
                return;
            }

            if (friendUsername === currentUser.username) {
                showNotification('You cannot add yourself as a friend', 'error');
                return;
            }

            try {
                const response = await fetch('/api/friends/request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: currentUser.username, 
                        friendUsername,
                        message: message || undefined
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Friend request sent!');
                    closeModal('add-friend-modal');
                    document.getElementById('friend-username').value = '';
                    document.getElementById('friend-message').value = '';
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                showNotification('Failed to send friend request', 'error');
            }
        }

        async function loadFriends() {
            try {
                const response = await fetch(`/api/friends/${currentUser.username}`);
                const data = await response.json();

                if (data.success) {
                    friends = data.friends;
                    renderFriendsList();
                }
            } catch (error) {
                console.error('Failed to load friends:', error);
            }
        }

        function renderFriendsList() {
            const friendsList = document.getElementById('friends-list');
            friendsList.innerHTML = '';

            if (friends.length === 0) {
                friendsList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); font-size: 0.85rem;">No friends yet</p>';
                return;
            }

            friends.forEach(friend => {
                const friendItem = document.createElement('div');
                friendItem.className = 'friend-item glass';
                friendItem.onclick = () => openFriendChat(friend.username);

                friendItem.innerHTML = `
                    <div class="friend-avatar" onclick="event.stopPropagation(); openFriendChat('${friend.username}')">
                        ${friend.avatar ? `<img src="${friend.avatar}" alt="${friend.username}">` : '<i class="fas fa-user"></i>'}
                    </div>
                    <div class="friend-info">
                        <div class="friend-name">${friend.username}</div>
                        <div class="friend-status ${friend.online ? 'status-online' : 'status-offline'}">
                            ${friend.online ? 'Online' : 'Offline'}
                        </div>
                        ${friend.since ? `<div style="font-size: 0.7rem; color: var(--text-secondary);">Friends since ${new Date(friend.since).toLocaleDateString()}</div>` : ''}
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="option-btn" onclick="event.stopPropagation(); removeFriend('${friend.username}')" title="Remove Friend">
                            <i class="fas fa-user-minus"></i>
                        </button>
                    </div>
                `;
                friendsList.appendChild(friendItem);
            });
        }

        async function removeFriend(friendUsername) {
            if (!confirm(`Are you sure you want to remove ${friendUsername} from your friends?`)) {
                return;
            }

            try {
                const response = await fetch('/api/friends/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser.username,
                        friendUsername: friendUsername
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification(`Removed ${friendUsername} from friends`);
                    loadFriends();
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                showNotification('Failed to remove friend', 'error');
            }
        }

        // Enhanced Group System
        function showCreateGroupModal() {
            // Populate friends checkboxes
            const checkboxesContainer = document.getElementById('friends-checkboxes');
            checkboxesContainer.innerHTML = '';

            if (friends.length === 0) {
                checkboxesContainer.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.85rem; text-align: center;">No friends to add to group</p>';
                return;
            }

            friends.forEach(friend => {
                const checkbox = document.createElement('div');
                checkbox.className = 'group-member-item';
                checkbox.innerHTML = `
                    <label style="display: flex; align-items: center; cursor: pointer; width: 100%;">
                        <input type="checkbox" value="${friend.username}" style="margin-right: 10px;">
                        <div class="group-member-avatar">
                            ${friend.avatar ? `<img src="${friend.avatar}" alt="${friend.username}" style="width: 100%; height: 100%; object-fit: cover;">` : '<i class="fas fa-user"></i>'}
                        </div>
                        <div class="group-member-name">${friend.username}</div>
                        <div class="friend-status ${friend.online ? 'status-online' : 'status-offline'}" style="font-size: 0.7rem;">
                            ${friend.online ? 'Online' : 'Offline'}
                        </div>
                    </label>
                `;
                checkboxesContainer.appendChild(checkbox);
            });

            showModal('create-group-modal');
        }

        async function createGroup() {
            const groupName = document.getElementById('group-name').value.trim();
            const groupDescription = document.getElementById('group-description').value.trim();
            const selectedFriends = Array.from(document.querySelectorAll('#friends-checkboxes input:checked'))
                .map(checkbox => checkbox.value);

            if (!groupName) {
                showNotification('Please enter a group name', 'error');
                return;
            }

            if (selectedFriends.length === 0) {
                showNotification('Please select at least one friend', 'error');
                return;
            }

            try {
                const response = await fetch('/api/groups/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: groupName,
                        description: groupDescription,
                        creator: currentUser.username,
                        members: [currentUser.username, ...selectedFriends]
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Group created successfully!');
                    closeModal('create-group-modal');
                    document.getElementById('group-name').value = '';
                    document.getElementById('group-description').value = '';
                    loadGroups();
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                showNotification('Failed to create group', 'error');
            }
        }

        async function loadGroups() {
            try {
                const response = await fetch(`/api/groups/${currentUser.username}`);
                const data = await response.json();

                if (data.success) {
                    groups = data.groups;
                    renderGroupsList();
                }
            } catch (error) {
                console.error('Failed to load groups:', error);
            }
        }

        function renderGroupsList() {
            const groupsList = document.getElementById('groups-list');
            groupsList.innerHTML = '';

            if (groups.length === 0) {
                groupsList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); font-size: 0.85rem;">No groups yet</p>';
                return;
            }

            groups.forEach(group => {
                const groupItem = document.createElement('div');
                groupItem.className = 'group-item glass';
                groupItem.onclick = () => openGroupChat(group.id, group.name);

                groupItem.innerHTML = `
                    <div class="group-avatar" onclick="event.stopPropagation(); openGroupChat('${group.id}', '${group.name}')">
                        <i class="fas fa-layer-group"></i>
                    </div>
                    <div class="group-info">
                        <div class="group-name">${group.name}</div>
                        <div class="group-members">${group.memberCount || group.members.length} members â€¢ Created by ${group.creator}</div>
                        <div style="font-size: 0.7rem; color: var(--text-secondary);">Last active: ${new Date(group.lastActivity).toLocaleDateString()}</div>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="option-btn" onclick="event.stopPropagation(); showGroupInfo('${group.id}')" title="Group Info">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>
                `;
                groupsList.appendChild(groupItem);
            });
        }

        function showGroupInfo(groupId) {
            const group = groups.find(g => g.id === groupId);
            if (!group) return;

            document.getElementById('group-info-title').textContent = group.name;
            const content = document.getElementById('group-info-content');

            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-size: 2rem;">
                        <i class="fas fa-layer-group"></i>
                    </div>
                    <h4 style="margin-bottom: 5px;">${group.name}</h4>
                    ${group.description ? `<p style="color: var(--text-secondary); font-size: 0.85rem;">${group.description}</p>` : ''}
                </div>
                
                <div class="form-group">
                    <label class="form-label">Group Members (${group.memberCount || group.members.length})</label>
                    <div class="group-members-list">
                        ${group.members.map(member => `
                            <div class="group-member-item">
                                <div class="group-member-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="group-member-name">${member}</div>
                                ${member === group.creator ? '<div class="group-member-role">Creator</div>' : ''}
                                ${member === currentUser.username ? '<div class="group-member-role">You</div>' : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn-secondary" onclick="leaveGroup('${group.id}')" style="flex: 1;">Leave Group</button>
                    ${group.creator === currentUser.username ? 
                        `<button class="btn" onclick="deleteGroup('${group.id}')" style="flex: 1;">Delete Group</button>` : 
                        ''
                    }
                </div>
            `;

            showModal('group-info-modal');
        }

        async function leaveGroup(groupId) {
            if (!confirm('Are you sure you want to leave this group?')) {
                return;
            }

            try {
                const response = await fetch('/api/groups/leave', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        groupId: groupId,
                        username: currentUser.username
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('You have left the group');
                    closeModal('group-info-modal');
                    loadGroups();
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                showNotification('Failed to leave group', 'error');
            }
        }

        async function deleteGroup(groupId) {
            if (!confirm('Are you sure you want to delete this group? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch('/api/groups/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        groupId: groupId,
                        username: currentUser.username
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Group deleted successfully');
                    closeModal('group-info-modal');
                    loadGroups();
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                showNotification('Failed to delete group', 'error');
            }
        }

        // Chat System
        function createNewChat() {
            showModal('new-chat-modal');
        }

        async function startNewChat() {
            const username = document.getElementById('chat-username').value.trim();

            if (!username) {
                showNotification('Please enter a username', 'error');
                return;
            }

            if (username === currentUser.username) {
                showNotification('You cannot chat with yourself', 'error');
                return;
            }

            try {
                const response = await fetch('/api/chats/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fromUser: currentUser.username,
                        toUser: username
                    })
                });

                const data = await response.json();

                if (data.success) {
                    if (data.chatExists) {
                        // Open existing chat
                        openChat(data.chatId, username);
                        showNotification('Chat opened!');
                    } else {
                        // Send chat request
                        showNotification('Chat request sent!');
                    }
                    closeModal('new-chat-modal');
                    document.getElementById('chat-username').value = '';
                    loadChats();
                } else {
                    if (data.message.includes('not found')) {
                        showNotification('Username not found. Try again.', 'error');
                    } else {
                        showNotification(data.message, 'error');
                    }
                }
            } catch (error) {
                showNotification('Failed to start chat', 'error');
            }
        }

        async function loadChats() {
            try {
                const response = await fetch(`/api/chats/${currentUser.username}`);
                const data = await response.json();

                if (data.success) {
                    chats = data.chats;
                    renderChatsList();
                }
            } catch (error) {
                console.error('Failed to load chats:', error);
            }
        }

        function renderChatsList() {
            const chatsList = document.getElementById('chats-list');
            chatsList.innerHTML = '';

            if (chats.length === 0) {
                chatsList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); font-size: 0.85rem;">No chats yet</p>';
                return;
            }

            // Sort chats: pinned first, then by last activity
            const sortedChats = [...chats].sort((a, b) => {
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;
                return new Date(b.lastActivity) - new Date(a.lastActivity);
            });

            sortedChats.forEach(chat => {
                const chatButton = document.createElement('button');
                chatButton.className = `chat-button glass ${chat.pinned ? 'pinned' : ''} ${chat.blocked ? 'blocked' : ''}`;
                chatButton.setAttribute('data-chat-id', chat.id);
                chatButton.setAttribute('data-username', chat.withUser);

                chatButton.innerHTML = `
                    <div class="friend-avatar" onclick="event.stopPropagation(); openChat('${chat.id}', '${chat.withUser}')">
                        ${chat.avatar ? `<img src="${chat.avatar}" alt="${chat.withUser}">` : 
                          chat.isGroup ? '<i class="fas fa-layer-group"></i>' : '<i class="fas fa-user"></i>'}
                    </div>
                    <div class="friend-info">
                        <div class="friend-name">${chat.withUser} ${chat.isGroup ? '<i class="fas fa-users" style="font-size: 0.7rem; margin-left: 5px;"></i>' : ''}</div>
                        <div class="friend-status">${chat.lastMessage || 'No messages yet'}</div>
                        <div class="encryption-status">
                            <i class="fas fa-lock"></i>
                            <span>End-to-End Encrypted</span>
                        </div>
                    </div>
                    <div class="chat-options">
                        <button class="option-btn" onclick="event.stopPropagation(); togglePin('${chat.id}')">
                            <i class="fas fa-thumbtack"></i>
                        </button>
                        <button class="option-btn" onclick="event.stopPropagation(); toggleBlock('${chat.id}')">
                            <i class="fas fa-ban"></i>
                        </button>
                    </div>
                `;

                // Add click event
                chatButton.addEventListener('click', () => openChat(chat.id, chat.withUser, chat.isGroup));

                // Add long press event
                chatButton.addEventListener('mousedown', startLongPress);
                chatButton.addEventListener('touchstart', startLongPress);
                chatButton.addEventListener('mouseup', cancelLongPress);
                chatButton.addEventListener('mouseleave', cancelLongPress);
                chatButton.addEventListener('touchend', cancelLongPress);

                chatsList.appendChild(chatButton);
            });
        }

        function openFriendChat(username) {
            // Find existing chat with this friend
            const existingChat = chats.find(chat => chat.withUser === username);
            if (existingChat) {
                openChat(existingChat.id, username);
            } else {
                // Create a new chat
                startNewChatWithUser(username);
            }
        }

        function openGroupChat(groupId, groupName) {
            openChat(groupId, groupName, true);
        }

        async function startNewChatWithUser(username) {
            try {
                const response = await fetch('/api/chats/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fromUser: currentUser.username,
                        toUser: username
                    })
                });

                const data = await response.json();

                if (data.success && data.chatExists) {
                    openChat(data.chatId, username);
                    loadChats();
                }
            } catch (error) {
                console.error('Failed to start chat:', error);
            }
        }

        async function openChat(chatId, username, isGroup = false) {
            activeChat = { id: chatId, username: username, isGroup: isGroup };

            // Update UI
            document.getElementById('chat-welcome').style.display = 'none';
            document.getElementById('chats-view').style.display = 'none';
            document.getElementById('friends-view').style.display = 'none';
            document.getElementById('groups-view').style.display = 'none';
            document.getElementById('active-chat').style.display = 'block';
            document.getElementById('message-input').style.display = 'flex';

            // Update chat header
            document.getElementById('active-chat-name').textContent = username;
            document.getElementById('active-chat-status').textContent = isGroup ? 'Group' : 'Online';

            // Update avatar in header
            const chat = chats.find(c => c.id === chatId);
            const avatarEl = document.getElementById('active-chat-avatar');
            if (chat && chat.avatar) {
                avatarEl.innerHTML = `<img src="${chat.avatar}" alt="${username}">`;
            } else {
                avatarEl.innerHTML = isGroup ? '<i class="fas fa-layer-group"></i>' : '<i class="fas fa-user"></i>';
            }

            // Pre-generate encryption key for this chat (only for direct messages)
            if (!isGroup) {
                await getChatKey(chatId, currentUser.username, username);
            }

            // Load chat messages
            loadChatMessages(chatId);
        }

        async function loadChatMessages(chatId) {
            try {
                const response = await fetch(`/api/chats/${chatId}/messages`);
                const data = await response.json();

                if (data.success) {
                    await renderMessages(data.messages);
                }
            } catch (error) {
                console.error('Failed to load messages:', error);
            }
        }

        async function renderMessages(messages) {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '';

            if (messages.length === 0) {
                messagesContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 15px; font-size: 0.85rem;">No messages yet. Start the conversation!</p>';
                return;
            }

            for (const message of messages) {
                const messageEl = document.createElement('div');
                messageEl.className = `message ${message.sender === currentUser.username ? 'outgoing' : 'incoming'}`;

                let messageContent = '';

                if (message.encryptedData && message.type === 'encrypted') {
                    // Handle encrypted messages - FIXED: Use proper decryption
                    try {
                        const key = await getChatKey(message.chatId, currentUser.username, activeChat.username);
                        const decryptedText = await decryptMessage(message.encryptedData, key);
                        messageContent = `<div class="message-text">${escapeHtml(decryptedText)}</div>`;
                    } catch (error) {
                        console.error('Decryption failed:', error);
                        messageContent = `<div class="message-text">ðŸ”’ Unable to decrypt message</div>`;
                    }
                } else if (message.file) {
                    // Handle file messages
                    messageContent = `
                        <div class="message-text">${message.text}</div>
                        <div class="file-message">
                            <div class="file-icon">
                                <i class="fas fa-${getFileIcon(message.file.type)}"></i>
                            </div>
                            <div class="file-info">
                                <div class="file-name">${message.file.originalname}</div>
                                <div class="file-size">${getFileSize(message.file.size)}</div>
                            </div>
                            <button class="download-btn" onclick="downloadFile('${message.file.path}', '${message.file.originalname}')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    `;
                } else {
                    // Handle plain text (legacy) messages
                    messageContent = `<div class="message-text">${escapeHtml(message.text)}</div>`;
                }

                messageEl.innerHTML = `
                    ${message.sender !== currentUser.username ? `<div class="message-sender">${message.sender}</div>` : ''}
                    ${messageContent}
                    <div class="message-time">${new Date(message.timestamp).toLocaleTimeString()}</div>
                `;
                messagesContainer.appendChild(messageEl);
            }

            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // File handling functions
        function getFileIcon(fileType) {
            switch(fileType) {
                case 'image': return 'image';
                case 'video': return 'video';
                default: return 'file';
            }
        }

        function getFileSize(bytes) {
            if (!bytes) return 'Unknown size';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }

        function downloadFile(path, filename) {
            const link = document.createElement('a');
            link.href = path;
            link.download = filename;
            link.click();
        }

        function toggleFileOptions() {
            const options = document.getElementById('file-options');
            options.style.display = options.style.display === 'flex' ? 'none' : 'flex';
        }

        function selectFile(type) {
            const fileInput = document.getElementById(`${type}-input`);
            fileInput.onchange = () => uploadFile(type, fileInput.files[0]);
            fileInput.click();
            toggleFileOptions();
        }

        async function uploadFile(type, file) {
            if (!file || !activeChat) return;

            const formData = new FormData();
            formData.append('file', file);
            formData.append('chatId', activeChat.id);
            formData.append('sender', currentUser.username);
            formData.append('fileType', type);

            try {
                const response = await fetch('/api/chats/file', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    loadChatMessages(activeChat.id);
                    loadChats();
                } else {
                    showNotification('Failed to send file', 'error');
                }
            } catch (error) {
                showNotification('Failed to send file', 'error');
            }
        }

        // Security: HTML escaping
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // FIXED: Enhanced sendMessage with proper encryption
        async function sendMessage() {
            const messageText = document.getElementById('message-text').value.trim();

            if (!messageText || !activeChat) return;

            if (messageText.length > 1000) {
                showNotification('Message too long (max 1000 characters)', 'error');
                return;
            }

            try {
                let encryptedData = null;

                // Only encrypt direct messages, not group messages
                if (!activeChat.isGroup) {
                    const key = await getChatKey(activeChat.id, currentUser.username, activeChat.username);
                    encryptedData = await encryptMessage(messageText, key);
                }

                const response = await fetch('/api/chats/message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chatId: activeChat.id,
                        sender: currentUser.username,
                        text: activeChat.isGroup ? messageText : null, // Send plain text for groups
                        encryptedData: activeChat.isGroup ? null : encryptedData // Send encrypted for direct messages
                    })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('message-text').value = '';
                    loadChatMessages(activeChat.id);
                    loadChats(); // Update chat list with last message
                } else {
                    showNotification('Failed to send message', 'error');
                }
            } catch (error) {
                console.error('Message sending error:', error);
                showNotification('Failed to send message', 'error');
            }
        }

        // Notifications System
        function showNotifications() {
            showModal('notifications-modal');
            renderNotifications();
        }

        function renderNotifications() {
            const notificationsList = document.getElementById('notifications-list');
            notificationsList.innerHTML = '';

            if (pendingRequests.length === 0) {
                notificationsList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); font-size: 0.85rem;">No new notifications</p>';
                return;
            }

            pendingRequests.forEach(request => {
                const notificationItem = document.createElement('div');
                notificationItem.className = 'friend-item glass';
                notificationItem.innerHTML = `
                    <div class="friend-info">
                        <div class="friend-name">${escapeHtml(request.fromUser)}</div>
                        <div class="friend-status">${request.type === 'friend' ? 'Friend Request' : 'Chat Request'}</div>
                        ${request.message ? `<div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px;">${request.message}</div>` : ''}
                        <div class="request-buttons">
                            <button class="accept-btn" onclick="handleRequest('${request.id}', 'accept')">âœ”ï¸ Accept</button>
                            <button class="decline-btn" onclick="handleRequest('${request.id}', 'decline')">ðŸš« Decline</button>
                        </div>
                    </div>
                `;
                notificationsList.appendChild(notificationItem);
            });
        }

        async function loadPendingRequests() {
            try {
                const response = await fetch(`/api/requests/${currentUser.username}`);
                const data = await response.json();

                if (data.success) {
                    pendingRequests = data.requests;
                    updateNotificationBadge();
                }
            } catch (error) {
                console.error('Failed to load requests:', error);
            }
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notification-badge');
            if (pendingRequests.length > 0) {
                badge.textContent = pendingRequests.length > 9 ? '9+' : pendingRequests.length;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        async function handleRequest(requestId, action) {
            try {
                const response = await fetch('/api/requests/handle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        requestId,
                        action
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification(`Request ${action}ed`);
                    loadPendingRequests();
                    if (action === 'accept') {
                        loadFriends();
                        loadChats();
                    }
                }
            } catch (error) {
                console.error('Failed to handle request:', error);
            }
        }

        // Long Press Context Menu
        function startLongPress(event) {
            const chatButton = event.currentTarget;
            selectedChat = {
                id: chatButton.getAttribute('data-chat-id'),
                username: chatButton.getAttribute('data-username')
            };

            longPressTimer = setTimeout(() => {
                showContextMenu(event);
            }, 500);
        }

        function cancelLongPress() {
            clearTimeout(longPressTimer);
        }

        function showContextMenu(event) {
            const contextMenu = document.getElementById('context-menu');
            contextMenu.style.display = 'block';
            contextMenu.style.left = `${event.clientX}px`;
            contextMenu.style.top = `${event.clientY}px`;

            // Hide context menu when clicking elsewhere
            document.addEventListener('click', hideContextMenu);
        }

        function hideContextMenu() {
            const contextMenu = document.getElementById('context-menu');
            contextMenu.style.display = 'none';
            document.removeEventListener('click', hideContextMenu);
        }

        function pinChat() {
            if (!selectedChat) return;
            // Implement pin functionality
            showNotification('Chat pinned');
            hideContextMenu();
        }

        function unpinChat() {
            if (!selectedChat) return;
            // Implement unpin functionality
            showNotification('Chat unpinned');
            hideContextMenu();
        }

        function blockUser() {
            if (!selectedChat) return;
            // Implement block functionality
            showNotification('User blocked');
            hideContextMenu();
        }

        function unblockUser() {
            if (!selectedChat) return;
            // Implement unblock functionality
            showNotification('User unblocked');
            hideContextMenu();
        }

        // Profile System
        function showUserProfile() {
            // Set current username in profile form
            document.getElementById('profile-username').value = currentUser.username;
            showModal('profile-modal');

            // Setup profile picture upload
            const fileInput = document.getElementById('profile-picture');
            const preview = document.getElementById('profile-preview');

            fileInput.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    // Validate file size
                    if (file.size > 5 * 1024 * 1024) {
                        showNotification('File too large (max 5MB)', 'error');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.innerHTML = `<img src="${e.target.result}" alt="Profile Preview">`;
                    };
                    reader.readAsDataURL(file);
                }
            };
        }

        function enableUsernameEdit() {
            const usernameInput = document.getElementById('profile-username');
            usernameInput.readOnly = false;
            usernameInput.focus();
        }

        async function updateProfile() {
            const usernameInput = document.getElementById('profile-username');
            const newUsername = usernameInput.value.trim();
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmNewPassword = document.getElementById('confirm-new-password').value;
            const profilePicture = document.getElementById('profile-picture').files[0];

            let updates = {};

            // Check if username changed
            if (newUsername !== currentUser.username) {
                if (newUsername.length < 3 || newUsername.length > 20) {
                    showNotification('Username must be between 3-20 characters', 'error');
                    return;
                }
                updates.newUsername = newUsername;
            }

            // Validate password change
            if (newPassword) {
                if (!currentPassword) {
                    showNotification('Current password is required to change password', 'error');
                    return;
                }

                if (newPassword !== confirmNewPassword) {
                    showNotification('New passwords do not match!', 'error');
                    return;
                }

                if (newPassword.length < 8) {
                    showNotification('New password must be at least 8 characters long!', 'error');
                    return;
                }

                updates.newPassword = newPassword;
                updates.currentPassword = currentPassword;
            }

            try {
                const formData = new FormData();
                formData.append('username', currentUser.username);

                if (updates.newUsername) {
                    formData.append('newUsername', updates.newUsername);
                }
                if (updates.currentPassword) {
                    formData.append('currentPassword', updates.currentPassword);
                }
                if (updates.newPassword) {
                    formData.append('newPassword', updates.newPassword);
                }

                if (profilePicture) {
                    formData.append('profilePicture', profilePicture);
                }

                const response = await fetch('/api/profile/update', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Profile updated successfully!');
                    closeModal('profile-modal');

                    // Clear form
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-new-password').value = '';
                    usernameInput.readOnly = true;

                    // Update current user data
                    if (data.user) {
                        currentUser = data.user;
                        updateUserAvatar();
                    }
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                showNotification('Failed to update profile', 'error');
            }
        }

        function showSettings() {
            showUserProfile();
        }

        function showSecurityInfo() {
            showModal('security-modal');
        }

        // WebSocket Setup
        function setupSocketListeners() {
            socket.on('friend_request', (data) => {
                showNotification(`New friend request from ${data.from}`);
                loadPendingRequests();
            });

            socket.on('chat_request', (data) => {
                showNotification(`New chat request from ${data.from}`);
                loadPendingRequests();
            });

            socket.on('friend_online', (data) => {
                showNotification(`${data.username} is now online`);
                loadFriends();
            });

            socket.on('friend_offline', (data) => {
                showNotification(`${data.username} is now offline`);
                loadFriends();
            });

            socket.on('new_message', async (data) => {
                if (activeChat && activeChat.id === data.chatId) {
                    await loadChatMessages(activeChat.id);
                } else {
                    showNotification(`New encrypted message from ${data.sender}`);
                }
                loadChats();
            });

            socket.on('chat_created', (data) => {
                showNotification(`New chat with ${data.with}`);
                loadChats();
            });

            socket.on('group_created', (data) => {
                showNotification(`Added to group: ${data.groupName}`);
                loadGroups();
            });

            socket.on('group_message', (data) => {
                if (activeChat && activeChat.id === data.chatId) {
                    loadChatMessages(activeChat.id);
                } else {
                    showNotification(`New message in ${data.groupName}`);
                }
                loadChats();
            });
        }

        // Close file options when clicking elsewhere
        document.addEventListener('click', function(event) {
            const options = document.getElementById('file-options');
            const clipBtn = document.querySelector('.clip-btn');

            if (options && clipBtn && !options.contains(event.target) && !clipBtn.contains(event.target)) {
                options.style.display = 'none';
            }
        });

        // Initialize enhanced features
        document.addEventListener('DOMContentLoaded', function() {
            createParticles();

            // Add GSAP animations to elements
            gsap.from('.logo-container', { duration: 1, y: -50, opacity: 0, delay: 0.2 });
            gsap.from('.auth-card', { duration: 1, y: 30, opacity: 0, delay: 0.5 });

            // Allow sending message with Enter key
            document.getElementById('message-text')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // Mobile viewport height fix
            function setViewportHeight() {
                let vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }

            setViewportHeight();
            window.addEventListener('resize', setViewportHeight);
            window.addEventListener('orientationchange', setViewportHeight);

            // Test encryption (uncomment to debug)
            // setTimeout(() => {
            //     if (currentUser) testEncryption();
            // }, 1000);
        });

        // Encryption test function
        async function testEncryption() {
            console.log('Testing encryption...');
            const testKey = await deriveChatKey('user1', 'user2');
            const testMessage = "Test encryption works!";

            try {
                const encrypted = await encryptMessage(testMessage, testKey);
                const decrypted = await decryptMessage(encrypted, testKey);

                console.log('Encryption test:', {
                    original: testMessage,
                    decrypted: decrypted,
                    success: testMessage === decrypted
                });

                return testMessage === decrypted;
            } catch (error) {
                console.error('Encryption test failed:', error);
                return false;
            }
        }
    </script>
</body>
</html>